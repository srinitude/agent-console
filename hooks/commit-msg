#!/bin/bash
# Git commit-msg hook to remove AI-related attributions from commit messages
#
# This hook removes:
# - Co-Authored-By lines (especially for AI tools like Claude, Anthropic, Cursor, Warp, Copilot)
# - References to AI assistants, bots, or automated tools
# - Mentions of Claude, Cursor, Warp, GitHub Copilot, or similar AI tools
# - "Generated by" or "Created with" attributions

COMMIT_MSG_FILE=$1

# Create a temporary file
TEMP_FILE=$(mktemp)

# Process the commit message line by line
while IFS= read -r line || [ -n "$line" ]; do
    # Skip Co-Authored-By lines that mention AI tools or bots
    if echo "$line" | grep -qiE "^Co-Authored-By:.*\b(claude|anthropic|cursor|warp|copilot|bot|ai|assistant|automated)\b"; then
        continue
    fi
    
    # Skip lines with "Generated by" or "Created with" followed by AI tools
    if echo "$line" | grep -qiE "^\s*(Generated by|Created with|Authored by|Assisted by).*\b(claude|anthropic|cursor|warp|copilot|ai|assistant|bot)\b"; then
        continue
    fi
    
    # Skip lines that are purely AI tool attributions
    if echo "$line" | grep -qiE "^\s*(Claude|Anthropic|Cursor|Warp|GitHub Copilot|Copilot)\s*(generated|created|assisted|authored)"; then
        continue
    fi
    
    # Keep the line
    echo "$line" >> "$TEMP_FILE"
done < "$COMMIT_MSG_FILE"

# Remove trailing blank lines from the end of the file
# This prevents accumulation of blank lines over multiple commits
# Use a more portable method that works on macOS and Linux
if command -v perl > /dev/null 2>&1; then
    # Use perl for portable in-place editing
    perl -i -pe 'chomp if eof' "$TEMP_FILE"
else
    # Fallback: use a simpler approach
    # Count non-empty lines from the end
    tac "$TEMP_FILE" | awk 'NF {found=1} found' | tac > "${TEMP_FILE}.trimmed"
    mv "${TEMP_FILE}.trimmed" "$TEMP_FILE"
fi

# Replace the original file with the cleaned version
mv "$TEMP_FILE" "$COMMIT_MSG_FILE"
